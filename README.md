# NGINX-KNOT 🧶

A dynamic NGINX microservice route configurator – **tie your fleet of thousands of microservices into a single reverse proxy configuration** with ease.

---

## 🔧 What is nginx-knot?

`nginx-knot` is a CLI-based tool that automates the generation, validation, and cleanup of NGINX configuration blocks (`upstream` and `location`) for microservices.

It helps teams:
- Dynamically generate and manage reverse proxy configurations.
- Keep NGINX configs modular, organized, and scalable.
- Avoid manual errors in `nginx.conf` maintenance.
- Centrally control and version service routes.
- Maintain audit logs of all config changes.

---

## 🌟 Features

✅ Automatically generates:
- `upstream` blocks with IP:port service definitions.
- Corresponding `location` blocks with custom proxy timeouts.

✅ Supports:
- **Create**, **delete** operations via CLI.
- **NGINX config validation** (`nginx -t`) before reload.
- **NGINX reload** (`systemctl reload nginx`) after successful validation.

✅ Designed for scale:
- Easily manages hundreds or thousands of microservices.

✅ Organized structure:
- Stores configs under:
  - `/etc/nginx/upstreams/`
  - `/etc/nginx/locations/`

✅ Logging:
- All actions logged at: `/var/log/nginx_knot.log`

---

## 📁 NGINX Config Structure
```
/etc/nginx/
├── upstreams/                  # Contains dynamically generated upstream blocks
│   ├── user-service.conf       # Upstream config for user-service (generated by nginx-knot)
├── locations/                  # Contains dynamically generated location blocks
│   ├── user-service.conf       # Location config for user-service (generated by nginx-knot)
├── conf.d/
│   └── default.conf            # Includes all location blocks, used in NGINX server configuration
├── scripts/
│   └── nginx-knot.py           # <<< Script will be here >>>
│                               # This script dynamically creates the above upstream and location configs
└── nginx.conf                  # Main NGINX config file
                                # Must include:
                                #   include /etc/nginx/upstreams/*.conf;
                                #   include /etc/nginx/conf.d/*.conf;
                                #   include /etc/nginx/sites-enabled/*;
```

## Sample Route Json
```
{
  "ms": [
    {
      "path": "^/user-service/",
      "upstream_name": "user_service",
      "upstream_ips": "10.10.0.11:8111",
      "action": "add"
    },
    {
      "path": "^/login-service/",
      "upstream_name": "login_service",
      "upstream_ips": "10.10.0.12:8111",
      "action": "add"
    }
  ],
  "check_config_already_exits": true,
  "validate_nginx": true,
  "reload_nginx": false
}
```

## ⚙️ Required NGINX Configuration
🔧 In nginx.conf add below give config.
This ensures that your microservice upstream definitions are globally available to all virtual hosts or server blocks.

```
http {
    ...

    # Include dynamically generated upstreams
    include /etc/nginx/upstreams/*.conf;

    # Other global includes
    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;

    ...
}
```

🔧 In /etc/nginx/conf.d/default.conf (or whatever is the name of your main config)
This ensures that your microservice upstream definitions are globally available to all virtual hosts or server blocks.
```
server {
    listen 80;
    listen [::]:80;

    server_name *.starexpo.com;

    # Include all dynamically generated location blocks
    include /etc/nginx/locations/*.conf;
}
```

## 🛠️ How to Use & 🧪 Validate
```
# Add or Update Service Configs
python3 nginx-knot.py --file=/path/to/fleet_config.json

# Quick Delete a Service Config
python3 nginx-knot.py --delete=user_service

# View NGINX Errors
tail -100f /var/log/nginx/error.log

# View Configurator Logs
tail -100f /var/log/nginx_knot.log

```

## 🪪 License

This project is licensed under the [MIT License](./LICENSE).

