# NGINX-KNOT ğŸ§¶

A dynamic NGINX microservice route configurator â€“ **tie your fleet of thousands of microservices into a single reverse proxy configuration** with ease.

---

## ğŸ”§ What is nginx-knot?

`nginx-knot` is a CLI-based tool that automates the generation, validation, and cleanup of NGINX configuration blocks (`upstream` and `location`) for microservices.

It helps teams:
- Dynamically generate and manage reverse proxy configurations.
- Keep NGINX configs modular, organized, and scalable.
- Avoid manual errors in `nginx.conf` maintenance.
- Centrally control and version service routes.
- Maintain audit logs of all config changes.

---

## ğŸŒŸ Features

âœ… Automatically generates:
- `upstream` blocks with IP:port service definitions.
- Corresponding `location` blocks with custom proxy timeouts.

âœ… Supports:
- **Create**, **delete** operations via CLI.
- **NGINX config validation** (`nginx -t`) before reload.
- **NGINX reload** (`systemctl reload nginx`) after successful validation.

âœ… Designed for scale:
- Easily manages hundreds or thousands of microservices.

âœ… Organized structure:
- Stores configs under:
  - `/etc/nginx/upstreams/`
  - `/etc/nginx/locations/`

âœ… Logging:
- All actions logged at: `/var/log/nginx_knot.log`

---

## ğŸ“ NGINX Config Structure
```
/etc/nginx/
â”œâ”€â”€ upstreams/                  # Contains dynamically generated upstream blocks
â”‚   â”œâ”€â”€ user-service.conf       # Upstream config for user-service (generated by nginx-knot)
â”œâ”€â”€ locations/                  # Contains dynamically generated location blocks
â”‚   â”œâ”€â”€ user-service.conf       # Location config for user-service (generated by nginx-knot)
â”œâ”€â”€ conf.d/
â”‚   â””â”€â”€ default.conf            # Includes all location blocks, used in NGINX server configuration
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ nginx-knot.py           # <<< Script will be here >>>
â”‚                               # This script dynamically creates the above upstream and location configs
â””â”€â”€ nginx.conf                  # Main NGINX config file
                                # Must include:
                                #   include /etc/nginx/upstreams/*.conf;
                                #   include /etc/nginx/conf.d/*.conf;
                                #   include /etc/nginx/sites-enabled/*;
```

## Sample Route Json
```
{
  "ms": [
    {
      "path": "^/user-service/",
      "upstream_name": "user_service",
      "upstream_ips": "10.10.0.11:8111",
      "action": "add"
    },
    {
      "path": "^/login-service/",
      "upstream_name": "login_service",
      "upstream_ips": "10.10.0.12:8111",
      "action": "add"
    }
  ],
  "check_config_already_exits": true,
  "validate_nginx": true,
  "reload_nginx": false
}
```

## âš™ï¸ Required NGINX Configuration
ğŸ”§ In nginx.conf add below give config.
This ensures that your microservice upstream definitions are globally available to all virtual hosts or server blocks.

```
http {
    ...

    # Include dynamically generated upstreams
    include /etc/nginx/upstreams/*.conf;

    # Other global includes
    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;

    ...
}
```

ğŸ”§ In /etc/nginx/conf.d/default.conf (or whatever is the name of your main config)
This ensures that your microservice upstream definitions are globally available to all virtual hosts or server blocks.
```
server {
    listen 80;
    listen [::]:80;

    server_name *.starexpo.com;

    # Include all dynamically generated location blocks
    include /etc/nginx/locations/*.conf;
}
```

## ğŸ› ï¸ How to Use & ğŸ§ª Validate
```
# Add or Update Service Configs
python3 nginx-knot.py --file=/path/to/fleet_config.json

# Quick Delete a Service Config
python3 nginx-knot.py --delete=user_service

# View NGINX Errors
tail -100f /var/log/nginx/error.log

# View Configurator Logs
tail -100f /var/log/nginx_knot.log

```

## ğŸªª License

This project is licensed under the [MIT License](./LICENSE).

